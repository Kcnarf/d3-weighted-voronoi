!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports):"function"==typeof define&&define.amd?define(["exports"],i):i(t.d3=t.d3||{})}(this,function(t){"use strict";function i(t){return 0===t}function e(t){var i=t.verts[0],e=t.verts[1],n=t.verts[2];this.a=i.y*(e.z-n.z)+e.y*(n.z-i.z)+n.y*(i.z-e.z),this.b=i.z*(e.x-n.x)+e.z*(n.x-i.x)+n.z*(i.x-e.x),this.c=i.x*(e.y-n.y)+e.x*(n.y-i.y)+n.x*(i.y-e.y),this.d=-1*(i.x*(e.y*n.z-n.y*e.z)+e.x*(n.y*i.z-i.y*n.z)+n.x*(i.y*e.z-e.y*i.z))}function n(t,i){this.x=t,this.y=i}function s(t,i){this.face=t,this.vert=i,this.nextf=null,this.prevf=null,this.nextv=null,this.prevv=null}function o(t){this.forFace=t,this.head=null}function h(t,i,e,n,s,h){this.x=t,this.y=i,this.weight=y,this.index=0,this.conflicts=new o(!1),this.neighbours=null,this.nonClippedPolygon=null,this.polygon=null,this.originalObject=null,this.isDummy=!1,void 0!==s&&(this.originalObject=s),void 0!=h&&(this.isDummy=h),null!=n&&(this.weight=n),this.z=null!=e?e:this.projectZ(this.x,this.y,this.weight)}function r(t,i,e){this.x=t,this.y=i,this.z=e}function l(t,i,e,n){this.conflicts=new o(!0),this.verts=[t,i,e],this.marked=!1;var s=t.subtract(i).crossproduct(i.subtract(e));this.normal=new r(-s.x,-s.y,-s.z),this.normal.normalize(),this.createEdges(),this.dualPoint=null,void 0!=n&&this.orient(n)}function u(t,i,e){this.next=null,this.prev=null,this.twin=null,this.orig=t,this.dest=i,this.iFace=e}function c(){this.points=[],this.facets=[],this.created=[],this.horizon=[],this.visible=[],this.current=0}function p(t,i){for(var e,n,s,o,h,r,l=d(i),u=-1,c=t.length-d(t),p=t[c-1];++u<c;){for(e=i.slice(),i.length=0,o=t[u],h=e[(s=e.length-l)-1],n=-1;++n<s;)r=e[n],a(r,p,o)?(a(h,p,o)||i.push(f(h,r,p,o)),i.push(r)):a(h,p,o)&&i.push(f(h,r,p,o)),h=r;l&&i.push(i[0]),p=o}return i}function a(t,i,e){return(e[0]-i[0])*(t[1]-i[1])<(e[1]-i[1])*(t[0]-i[0])}function f(t,i,e,n){var s=t[0],o=e[0],h=i[0]-s,r=n[0]-o,l=t[1],u=e[1],c=i[1]-l,p=n[1]-u,a=(r*(l-u)-p*(s-o))/(p*h-r*c);return[s+a*h,l+a*c]}function d(t){var i=t[0],e=t[t.length-1];return!(i[0]-e[0]||i[1]-e[1])}function v(t){var i=[],e=t,n=t.dest,s=n.originalObject,o=[];do{e=e.twin.prev;var h=e.orig.originalObject;h.isDummy||o.push(h);var r=e.iFace;r.isVisibleFromBelow()&&i.push(r)}while(e!==t);return s.neighbours=o,i}function g(t,i,e){var n=new c;n.clear(),n.init(i,t);for(var s=n.compute(t),o=[],h=(n.points.length,[]),r=s.length,l=0;l<r;l++){var u=s[l];if(u.isVisibleFromBelow())for(var a=0;a<3;a++){var f=u.edges[a],d=f.dest,g=d.originalObject;if(!h[d.index]){if(h[d.index]=!0,g.isDummy)continue;for(var x=v(f),z=[],w=null,m=null,b=1,F=1,k=0;k<x.length;k++){var P=x[k].getDualPoint(),C=P.x,E=P.y;null!==w&&(b=w-C,F=m-E,b<0&&(b=-b),F<0&&(F=-F)),(b>y||F>y)&&(z.push([C,E]),w=C,m=E)}if(g.nonClippedPolygon=z.reverse(),!g.isDummy&&d3.polygonLength(g.nonClippedPolygon)>0){var D=p(e,g.nonClippedPolygon);g.polygon=D,D.site=g,D.length>0&&o.push(D)}}}}return o}var y=1e-10,x=function(t,i){return t.x*i.x+t.y*i.y+t.z*i.z};e.prototype.getDualPointMappedToPlane=function(){var t=this.getNormZPlane();return new n(t[0]/2,t[1]/2)},e.prototype.getNormZPlane=function(){return[this.a/this.c*-1,this.b/this.c*-1,this.d/this.c*-1]},o.prototype.add=function(t){null===this.head?this.head=t:this.forFace?(this.head.prevv=t,t.nextv=this.head,this.head=t):(this.head.prevf=t,t.nextf=this.head,this.head=t)},o.prototype.isEmpty=function(){return null===this.head},o.prototype.fill=function(t){if(!this.forFace){var i=this.head;do{t.push(i.face),i.face.marked=!0,i=i.nextf}while(null!==i)}},o.prototype.removeAll=function(){if(this.forFace){var t=this.head;do{null===t.prevf?null===t.nextf?t.vert.conflicts.head=null:(t.nextf.prevf=null,t.vert.conflicts.head=t.nextf):(null!=t.nextf&&(t.nextf.prevf=t.prevf),t.prevf.nextf=t.nextf),null!=(t=t.nextv)&&(t.prevv=null)}while(null!=t)}else{var t=this.head;do{null==t.prevv?null==t.nextv?t.face.conflicts.head=null:(t.nextv.prevv=null,t.face.conflicts.head=t.nextv):(null!=t.nextv&&(t.nextv.prevv=t.prevv),t.prevv.nextv=t.nextv),null!=(t=t.nextf)&&(t.prevf=null)}while(null!=t)}},o.prototype.getVertices=function(){for(var t=[],i=this.head;null!==i;)t.push(i.vert),i=i.nextv;return t},h.prototype.setWeight=function(t){this.weight=t,this.z=this.projectZ(this.x,this.y,this.weight)},h.prototype.projectZ=function(t,i,e){return t*t+i*i-e},h.prototype.subtract=function(t){return new h(t.x-this.x,t.y-this.y,t.z-this.z)},h.prototype.crossproduct=function(t){return new h(this.y*t.z-this.z*t.y,this.z*t.x-this.x*t.z,this.x*t.y-this.y*t.x)},h.prototype.equals=function(t){return this.x===t.x&&this.y===t.y&&this.z===t.z},r.prototype.negate=function(){this.x*=-1,this.y*=-1,this.z*=-1},r.prototype.normalize=function(){var t=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);t>0&&(this.x/=t,this.y/=t,this.z/=t)},l.prototype.getDualPoint=function(){if(null==this.dualPoint){var t=new e(this);this.dualPoint=t.getDualPointMappedToPlane()}return this.dualPoint},l.prototype.isVisibleFromBelow=function(){return this.normal.z<-1.4259414393190911e-9},l.prototype.createEdges=function(){this.edges=[],this.edges[0]=new u(this.verts[0],this.verts[1],this),this.edges[1]=new u(this.verts[1],this.verts[2],this),this.edges[2]=new u(this.verts[2],this.verts[0],this),this.edges[0].next=this.edges[1],this.edges[0].prev=this.edges[2],this.edges[1].next=this.edges[2],this.edges[1].prev=this.edges[0],this.edges[2].next=this.edges[0],this.edges[2].prev=this.edges[1]},l.prototype.orient=function(t){if(!(x(this.normal,t)<x(this.normal,this.verts[0]))){var i=this.verts[1];this.verts[1]=this.verts[2],this.verts[2]=i,this.normal.negate(),this.createEdges()}},l.prototype.getEdge=function(t,i){for(var e=0;e<3;e++)if(this.edges[e].isEqual(t,i))return this.edges[e];return null},l.prototype.link=function(t,i,e){if(t instanceof l){var n=t.getEdge(i,e);null===n&&console.log("ERROR: twin is null");var s=this.getEdge(i,e);n.twin=s,s.twin=n}else{var o=t,s=this.getEdge(o.orig,o.dest);o.twin=s,s.twin=o}},l.prototype.conflict=function(t){return x(this.normal,t)>x(this.normal,this.verts[0])+y},l.prototype.getHorizon=function(){for(var t=0;t<3;t++)if(null!==this.edges[t].twin&&this.edges[t].twin.isHorizon())return this.edges[t];return null},l.prototype.removeConflict=function(){this.conflicts.removeAll()},u.prototype.isHorizon=function(){return null!==this.twin&&this.twin.iFace.marked&&!this.iFace.marked},u.prototype.findHorizon=function(t){if(this.isHorizon()){if(t.length>0&&this===t[0])return;t.push(this),this.next.findHorizon(t)}else null!==this.twin&&this.twin.next.findHorizon(t)},u.prototype.isEqual=function(t,i){return this.orig.equals(t)&&this.dest.equals(i)||this.orig.equals(i)&&this.dest.equals(t)},c.prototype.init=function(t,i){this.points=[];for(var e=0;e<i.length;e++)this.points[e]=new h(i[e].x,i[e].y,i[e].z,null,i[e],!1);this.points=this.points.concat(t)},c.prototype.permutate=function(){for(var t=this.points.length,i=t-1;i>0;i--){var e=Math.floor(Math.random()*i),n=this.points[e];n.index=i;var s=this.points[i];s.index=e,this.points.splice(e,1,s),this.points.splice(i,1,n)}},c.prototype.prep=function(){this.points.length<=3&&console.log("ERROR: Less than 4 points");for(var t=0;t<this.points.length;t++)this.points[t].index=t;var i,e,n,s,o,h,r,u;i=this.points[0],e=this.points[1],n=s=null;for(var t=2;t<this.points.length;t++)if(!this.linearDependent(i,this.points[t])||!this.linearDependent(e,this.points[t])){n=this.points[t],n.index=2,this.points[2].index=t,this.points.splice(t,1,this.points[2]),this.points.splice(2,1,n);break}null===n&&console.log("ERROR: v2 is null"),u=new l(i,e,n);for(var t=3;t<this.points.length;t++)if(x(u.normal,u.verts[0])!==x(u.normal,this.points[t])){s=this.points[t],s.index=3,this.points[3].index=t,this.points.splice(t,1,this.points[3]),this.points.splice(3,1,s);break}null===s&&console.log("ERROR: v3 is null"),u.orient(s),o=new l(i,n,s,e),h=new l(i,e,s,n),r=new l(e,n,s,i),this.addFacet(u),this.addFacet(o),this.addFacet(h),this.addFacet(r),u.link(o,i,n),u.link(h,i,e),u.link(r,e,n),o.link(h,i,s),o.link(r,n,s),h.link(r,s,e),this.current=4;for(var c,t=this.current;t<this.points.length;t++)c=this.points[t],u.conflict(c)&&this.addConflict(u,c),o.conflict(c)&&this.addConflict(o,c),h.conflict(c)&&this.addConflict(h,c),r.conflict(c)&&this.addConflict(r,c)},c.prototype.addConflicts=function(t,i,e){var n,s,o,h,r=t.conflicts.getVertices(),l=i.conflicts.getVertices(),u=[];for(o=h=0;o<r.length||h<l.length;)o<r.length&&h<l.length?(n=r[o],s=l[h],n.index===s.index?(u.push(n),o++,h++):n.index>s.index?(u.push(n),o++):(u.push(s),h++)):o<r.length?u.push(r[o++]):u.push(l[h++]);for(var o=u.length-1;o>=0;o--)n=u[o],e.conflict(n)&&this.addConflict(e,n)},c.prototype.addConflict=function(t,i){var e=new s(t,i);t.conflicts.add(e),i.conflicts.add(e)},c.prototype.removeConflict=function(t){t.removeConflict();var i=t.index;if(t.index=-1,i===this.facets.length-1)return void this.facets.splice(this.facets.length-1,1);if(!(i>=this.facets.length||i<0)){var e=this.facets.splice(this.facets.length-1,1);e[0].index=i,this.facets.splice(i,1,e[0])}},c.prototype.addFacet=function(t){t.index=this.facets.length,this.facets.push(t)},c.prototype.compute=function(){for(this.prep();this.current<this.points.length;){var t=this.points[this.current];if(t.conflicts.isEmpty())this.current++;else{this.created=[],this.horizon=[],this.visible=[],t.conflicts.fill(this.visible);for(var i,e=0;e<this.visible.length;e++)if(null!==(i=this.visible[e].getHorizon())){i.findHorizon(this.horizon);break}for(var n=null,s=null,h=0;h<this.horizon.length;h++){var r=this.horizon[h],u=new l(t,r.orig,r.dest,r.twin.next.dest);u.conflicts=new o(!0),this.addFacet(u),this.created.push(u),this.addConflicts(r.iFace,r.twin.iFace,u),u.link(r),null!==n&&u.link(n,t,r.orig),n=u,null===s&&(s=u)}if(null!==s&&null!==n&&n.link(s,t,this.horizon[0].orig),0!=this.created.length){for(var c=0;c<this.visible.length;c++)this.removeConflict(this.visible[c]);this.current++,this.created=[]}}}return this.facets},c.prototype.linearDependent=function(t,e){return 0==t.x&&0==e.x?0==t.y&&0==e.y?0==t.z&&0==e.z||0!=t.z&&0!=e.z:0!=t.y&&0!=e.y&&!!i(t.z/t.y-e.z/e.y):0!=t.x&&0!=e.x&&!(!i(t.y/t.x-e.y/e.x)||!i(t.z/t.x-e.y/e.x))},c.prototype.clear=function(){this.points=[],this.facets=[],this.created=[],this.horizon=[],this.visible=[],this.current=0},t.weightedVoronoi=g,t.Vertex=h,Object.defineProperty(t,"__esModule",{value:!0})});